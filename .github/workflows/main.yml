name: Build OpenWrt Package for AW1000

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: false
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-22.04 # 建议使用较新的 ubuntu-22.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4 # 建议使用 v4

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo -E apt-get -qq update
        sudo -E apt-get -qq install build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget python3-pyelftools python3-setuptools python3-dev libpython3-dev subversion
        sudo -E apt-get -qq autoremove --purge
        sudo -E apt-get -qq clean
        sudo timedatectl set-timezone "$TZ"
        
    - name: Download OpenWrt SDK
      run: |
        cd $GITHUB_WORKSPACE
        wget -q https://downloads.openwrt.org/releases/23.05.4/targets/ipq807x/generic/openwrt-sdk-23.05.4-ipq807x-generic_gcc-12.3.0_musl.Linux-x86_64.tar.xz || \
        wget -q https://downloads.openwrt.org/snapshots/targets/ipq807x/generic/openwrt-sdk-ipq807x-generic_gcc-13.2.0_musl.Linux-x86_64.tar.xz
        tar -xf openwrt-sdk-*.tar.xz
        mv openwrt-sdk-* openwrt-sdk
        
    - name: Load custom feeds
      run: |
        cd openwrt-sdk
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
    - name: Prepare package
      run: |
        mkdir -p openwrt-sdk/package/DbusSmsForwardCPlus
        # 使用 rsync 更可靠地复制文件，并排除 .git 目录
        rsync -a --exclude='.git/' --exclude='.github/' ./ openwrt-sdk/package/DbusSmsForwardCPlus/
        
    - name: Create package Makefile
      run: |
        cat > openwrt-sdk/package/DbusSmsForwardCPlus/Makefile << 'EOL'
        include $(TOPDIR)/rules.mk

        PKG_NAME:=DbusSmsForwardCPlus
        PKG_VERSION:=1.0.0
        PKG_RELEASE:=1

        PKG_BUILD_DIR:=$(BUILD_DIR)/$(PKG_NAME)-$(PKG_VERSION)
        PKG_LICENSE:=GPL-3.0

        include $(INCLUDE_DIR)/package.mk

        define Package/DbusSmsForwardCPlus
          SECTION:=utils
          CATEGORY:=Utilities
          TITLE:=SMS forwarding tool via D-Bus
          DEPENDS:=+dbus +libcurl +libstdcpp +libpthread
        endef

        define Build/Prepare
        	mkdir -p $(PKG_BUILD_DIR)
        	$(CP) ./*.cpp $(PKG_BUILD_DIR)/ 2>/dev/null || true
        	$(CP) ./*.h $(PKG_BUILD_DIR)/ 2>/dev/null || true
        	$(CP) ./src/* $(PKG_BUILD_DIR)/ 2>/dev/null || true
        endef

        define Build/Compile
        	$(MAKE) -C $(PKG_BUILD_DIR) \
        		CC="$(TARGET_CC)" \
        		CXX="$(TARGET_CXX)" \
        		CFLAGS="$(TARGET_CFLAGS)" \
        		CXXFLAGS="$(TARGET_CXXFLAGS) -std=c++11 -pthread" \
        		LDFLAGS="$(TARGET_LDFLAGS)" \
        		LIBS="-ldbus-1 -lcurl -lpthread" \
        		-f $(CURDIR)/Makefile.build
        endef

        define Package/DbusSmsForwardCPlus/install
        	$(INSTALL_DIR) $(1)/usr/bin
        	$(INSTALL_BIN) $(PKG_BUILD_DIR)/DbusSmsForwardCPlus $(1)/usr/bin/
        endef

        $(eval $(call BuildPackage,DbusSmsForwardCPlus))
        EOL
        
    - name: Create build Makefile
      run: |
        cat > openwrt-sdk/package/DbusSmsForwardCPlus/Makefile.build << 'EOL'
        SOURCES = $(wildcard *.cpp)
        OBJECTS = $(SOURCES:.cpp=.o)
        TARGET = DbusSmsForwardCPlus

        CXXFLAGS += -std=c++11 -pthread -Wall -O2
        LIBS += -ldbus-1 -lcurl -lpthread

        all: $(TARGET)

        $(TARGET): $(OBJECTS)
        	$(CXX) $(OBJECTS) -o $@ $(LDFLAGS) $(LIBS)

        %.o: %.cpp
        	$(CXX) $(CXXFLAGS) -c $< -o $@

        clean:
        	rm -f $(OBJECTS) $(TARGET)
        EOL
        
    - name: Generate configuration file and select packages
      run: |
        cd openwrt-sdk
        # 生成默认配置
        make defconfig
        # 在 .config 文件中自动选中我们的包和它的依赖
        echo "CONFIG_PACKAGE_DbusSmsForwardCPlus=m" >> .config
        echo "CONFIG_PACKAGE_libcurl=m" >> .config
        echo "CONFIG_PACKAGE_dbus=m" >> .config
        # 重新生成最终配置，确保所有依赖项被包含
        make defconfig

    - name: Build package
      run: |
        cd openwrt-sdk
        make package/DbusSmsForwardCPlus/compile V=s -j$(nproc)
        
    - name: Organize files
      run: |
        mkdir -p ./artifact
        find openwrt-sdk/bin/ -name "*.ipk" -exec cp {} ./artifact/ \;
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4 # 建议使用 v4
      with:
        name: DbusSmsForwardCPlus-AW1000
        path: ./artifact/*.ipk
