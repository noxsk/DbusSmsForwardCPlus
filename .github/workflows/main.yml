name: Build OpenWrt package (DbusSmsForwardCPlus) for qualcommax/ipq807x (24.10.1)

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
    paths:
      - 'DbusSmsForwardCPlus/**'
      - '**/*.cpp'
      - '**/*.h'
      - '**/*.hpp'
      - '.github/workflows/build-ipq807x.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      SDK_URL: https://archive.openwrt.org/releases/24.10.1/targets/qualcommax/ipq807x/openwrt-sdk-24.10.1-qualcommax-ipq807x_gcc-13.3.0_musl.Linux-x86_64.tar.zst
      FEED_NAME: nox
      PKG_NAME: dbus-sms-forward-cplus
      SDK_DIR: /home/runner/sdk/openwrt-sdk-24.10.1-qualcommax-ipq807x_gcc-13.3.0_musl.Linux-x86_64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install host build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gawk unzip wget rsync zstd libncurses5-dev zlib1g-dev python3 file git ca-certificates

      - name: Download & unpack OpenWrt SDK
        run: |
          set -euxo pipefail
          mkdir -p /home/runner/sdk && cd /home/runner/sdk
          wget -q $SDK_URL -O sdk.tar.zst
          tar -I zstd -xf sdk.tar.zst
          test -d "$SDK_DIR"

      - name: Prepare local feed (package recipe + init/config)
        run: |
          set -euxo pipefail
          mkdir -p $GITHUB_WORKSPACE/openwrt-packages/${PKG_NAME}/files/etc/init.d
          mkdir -p $GITHUB_WORKSPACE/openwrt-packages/${PKG_NAME}/files/etc/config

          cat > $GITHUB_WORKSPACE/openwrt-packages/${PKG_NAME}/Makefile <<'EOF'
          include $(TOPDIR)/rules.mk

          PKG_NAME:=dbus-sms-forward-cplus
          PKG_RELEASE:=1

          PKG_SOURCE_PROTO:=git
          PKG_SOURCE_URL:=https://github.com/noxsk/DbusSmsForwardCPlus.git
          PKG_SOURCE_VERSION:=${GIT_COMMIT}
          PKG_MIRROR_HASH:=skip

          PKG_BUILD_DIR:=$(BUILD_DIR)/$(PKG_NAME)-$(PKG_SOURCE_VERSION)
          MAKE_PATH:=DbusSmsForwardCPlus

          include $(INCLUDE_DIR)/package.mk

          define Package/$(PKG_NAME)
            SECTION:=utils
            CATEGORY:=Utilities
            TITLE:=Dbus SMS Forwarder (C++)
            URL:=https://github.com/noxsk/DbusSmsForwardCPlus
            DEPENDS:=+libdbus +libopenssl +libstdcpp +libpthread +ca-bundle
          endef

          define Package/$(PKG_NAME)/description
          C++ D-Bus SMS forwarder using ModemManager (Email/PushPlus/WeCom/TG/DingTalk/Bark/Shell), with a simple Web API/page to send SMS.
          endef

          DBUS_CFLAGS := -I$(STAGING_DIR)/usr/include/dbus-1.0 -I$(STAGING_DIR)/usr/lib/dbus-1.0/include

          define Build/Compile
            $(TARGET_CXX) $(TARGET_CXXFLAGS) -std=c++17 -Os -pipe -fno-plt -DCPPHTTPLIB_OPENSSL_SUPPORT \
              -I$(PKG_BUILD_DIR)/DbusSmsForwardCPlus \
              -I$(PKG_BUILD_DIR)/DbusSmsForwardCPlus/rapidjson \
              $(DBUS_CFLAGS) \
              $$(find $(PKG_BUILD_DIR)/DbusSmsForwardCPlus -type f -name '*.cpp' | tr '\n' ' ') \
              -o $(PKG_BUILD_DIR)/DbusSmsForwardCPlus/DbusSmsForwardCPlus \
              $(TARGET_LDFLAGS) -ldbus-1 -lssl -lcrypto -lpthread
          endef

          define Package/$(PKG_NAME)/install
            $(INSTALL_DIR) $(1)/usr/bin
            $(INSTALL_BIN) $(PKG_BUILD_DIR)/DbusSmsForwardCPlus/DbusSmsForwardCPlus $(1)/usr/bin/DbusSmsForwardCPlus

            $(INSTALL_DIR) $(1)/etc/init.d
            $(INSTALL_BIN) ./files/etc/init.d/$(PKG_NAME) $(1)/etc/init.d/$(PKG_NAME)

            $(INSTALL_DIR) $(1)/etc/config
            $(INSTALL_CONF) ./files/etc/config/$(PKG_NAME) $(1)/etc/config/$(PKG_NAME)
          endef

          $(eval $(call BuildPackage,$(PKG_NAME)))
          EOF

          cat > $GITHUB_WORKSPACE/openwrt-packages/${PKG_NAME}/files/etc/init.d/${PKG_NAME} <<'EOF'
          #!/bin/sh /etc/rc.common
          START=95
          USE_PROCD=1
          CFG=dbus-sms-forward-cplus
          start_service() {
              . /lib/functions.sh
              config_load $CFG
              config_get_bool enabled main enabled 0
              [ "$enabled" -eq 1 ] || exit 0
              config_get conf main configfile "/etc/dbus-sms-forward-cplus/config.txt"
              config_get args main args ""
              mkdir -p /etc/dbus-sms-forward-cplus
              [ -f "$conf" ] || touch "$conf"
              procd_open_instance
              procd_set_param command /usr/bin/DbusSmsForwardCPlus --configfile="$conf" $args
              procd_set_param respawn 3600 5 5
              procd_set_param stdout 1
              procd_set_param stderr 1
              procd_close_instance
          }
          EOF
          chmod +x $GITHUB_WORKSPACE/openwrt-packages/${PKG_NAME}/files/etc/init.d/${PKG_NAME}

          cat > $GITHUB_WORKSPACE/openwrt-packages/${PKG_NAME}/files/etc/config/${PKG_NAME} <<'EOF'
          config main 'main'
              option enabled '1'
              option configfile '/etc/dbus-sms-forward-cplus/config.txt'
              option args '--sendsmsapi=enable -fB -fP'
          EOF

      - name: Build with SDK (GitHub mirrors + minimal feeds + robust install)
        env:
          GIT_COMMIT: ${{ github.sha }}
        run: |
          set -euxo pipefail
          cd "$SDK_DIR"

          # 仅 base + packages + 你的本地 feed（GitHub 镜像更稳）
          cat > feeds.conf <<'EOF'
          src-git base https://github.com/openwrt/openwrt.git;openwrt-24.10
          src-git packages https://github.com/openwrt/packages.git;openwrt-24.10
          src-link nox $GITHUB_WORKSPACE/openwrt-packages
          EOF

          git config --global protocol.version 2
          git config --global http.postBuffer 524288000
          export GIT_TERMINAL_PROMPT=0

          retry() { n=0; until "$@"; do n=$((n+1)); [ $n -ge 5 ] && exit 1; sleep $((10*n)); done; }

          retry ./scripts/feeds update base
          retry ./scripts/feeds update packages
          ./scripts/feeds update nox

          # 列一下 feed/nox 视图（调试）
          ls -la feeds || true
          ls -la feeds/nox || true
          find feeds/nox -maxdepth 2 -type f -name Makefile || true

          # 尝试通过 feeds 安装到 package/feeds/<FEED_NAME>，不行再兜底
          ./scripts/feeds install -p packages openssl dbus || true
          ./scripts/feeds install -p nox ${PKG_NAME} || true
          ./scripts/feeds install -a -p nox || true

          # 兜底：若仍未出现，则手动建到 package/feeds/<FEED_NAME>/<PKG_NAME>
          if [ ! -d "package/feeds/${FEED_NAME}/${PKG_NAME}" ]; then
            echo "feeds install didn't materialize package; creating manual symlink..."
            mkdir -p "package/feeds/${FEED_NAME}"
            ln -sf "$GITHUB_WORKSPACE/openwrt-packages/${PKG_NAME}" "package/feeds/${FEED_NAME}/${PKG_NAME}"
          fi

          # 最终确认
          test -d "package/feeds/${FEED_NAME}/${PKG_NAME}" || {
            echo "Package still missing under package/feeds/${FEED_NAME}/${PKG_NAME}"
            find package/feeds -maxdepth 2 -type d
            exit 1
          }

          make defconfig

          # 先把依赖打到 staging
          make -j"$(nproc)" V=s \
            package/feeds/packages/openssl/compile \
            package/feeds/packages/dbus/compile

          # 编译你的包
          make -j"$(nproc)" V=s package/feeds/${FEED_NAME}/${PKG_NAME}/compile

          # 输出索引
          make package/index
          echo "PKG_DIR=$(ls -d bin/packages/*/${FEED_NAME} | head -n1)" >> $GITHUB_ENV

      - name: Upload ipk artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dbus-sms-forward-cplus-qualcommax-ipq807x-24.10.1
          path: |
            ${{ env.PKG_DIR }}/dbus-sms-forward-cplus_*.ipk
            ${{ env.PKG_DIR }}/Packages*
