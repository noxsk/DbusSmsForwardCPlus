name: Build OpenWrt package (DbusSmsForwardCPlus) for qualcommax/ipq807x (24.10.1)

on:
  workflow_dispatch:
  push:
    branches: [ master, main ]
    paths:
      - '**/*.cpp'
      - '**/*.h'
      - '**/*.hpp'
      - '.github/workflows/build-ipq807x.yml'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      SDK_URL: https://archive.openwrt.org/releases/24.10.1/targets/qualcommax/ipq807x/openwrt-sdk-24.10.1-qualcommax-ipq807x_gcc-13.3.0_musl.Linux-x86_64.tar.zst
      FEED_NAME: nox
      PKG_NAME: dbus-sms-forward-cplus
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install host build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential gawk unzip wget rsync zstd libncurses5-dev zlib1g-dev python3 file git

      - name: Download & unpack OpenWrt SDK (24.10.1 / qualcommax/ipq807x)
        run: |
          mkdir -p $HOME/sdk && cd $HOME/sdk
          wget -q $SDK_URL -O sdk.tar.zst
          tar -I zstd -xf sdk.tar.zst
          SDK_DIR=$(find . -maxdepth 1 -type d -name "openwrt-sdk-*" | head -n1)
          echo "SDK_DIR=$HOME/sdk/$SDK_DIR" >> $GITHUB_ENV

      - name: Prepare local feed (package recipe + init/config)
        run: |
          set -eux
          mkdir -p $GITHUB_WORKSPACE/openwrt-packages/${{ env.PKG_NAME }}/files/etc/init.d
          mkdir -p $GITHUB_WORKSPACE/openwrt-packages/${{ env.PKG_NAME }}/files/etc/config

          # ------- OpenWrt package Makefile (构建/安装规则) -------
          # 这里固定源码为你当前 fork + 触发工作流的这次提交
          cat > $GITHUB_WORKSPACE/openwrt-packages/${{ env.PKG_NAME }}/Makefile <<EOF
          include \$(TOPDIR)/rules.mk

          PKG_NAME:=${{ env.PKG_NAME }}
          PKG_RELEASE:=1

          PKG_SOURCE_PROTO:=git
          PKG_SOURCE_URL:=https://github.com/noxsk/DbusSmsForwardCPlus.git
          PKG_SOURCE_VERSION:=${{ github.sha }}
          PKG_MIRROR_HASH:=skip

          PKG_BUILD_DIR:=\$(BUILD_DIR)/\$(PKG_NAME)-\$(PKG_SOURCE_VERSION)
          # 源码位于子目录 DbusSmsForwardCPlus
          MAKE_PATH:=DbusSmsForwardCPlus

          PKG_LICENSE:=unknown
          PKG_MAINTAINER:=noxsk

          include \$(INCLUDE_DIR)/package.mk

          define Package/\$(PKG_NAME)
            SECTION:=utils
            CATEGORY:=Utilities
            TITLE:=Dbus SMS Forwarder (C++)
            URL:=https://github.com/noxsk/DbusSmsForwardCPlus
            DEPENDS:=+libdbus +libopenssl +libstdcpp +libpthread +ca-bundle
          endef

          define Package/\$(PKG_NAME)/description
          C++ D-Bus SMS forwarder using ModemManager (Email/PushPlus/WeCom/TG/DingTalk/Bark/Shell), with a simple Web API/page to send SMS.
          endef

          # dbus 头文件路径（OpenWrt SDK 提供）
          DBUS_CFLAGS := -I\$(STAGING_DIR)/usr/include/dbus-1.0 -I\$(STAGING_DIR)/usr/lib/dbus-1.0/include

          define Build/Compile
          	\$(TARGET_CXX) \$(TARGET_CXXFLAGS) -std=c++17 -Os -DCPPHTTPLIB_OPENSSL_SUPPORT \\
          		-I\$(PKG_BUILD_DIR)/DbusSmsForwardCPlus \\
          		-I\$(PKG_BUILD_DIR)/DbusSmsForwardCPlus/rapidjson \\
          		\$(DBUS_CFLAGS) \\
          		\$(PKG_BUILD_DIR)/DbusSmsForwardCPlus/*.cpp \\
          		\$(PKG_BUILD_DIR)/DbusSmsForwardCPlus/*/*.cpp \\
          		-o \$(PKG_BUILD_DIR)/DbusSmsForwardCPlus/DbusSmsForwardCPlus \\
          		\$(TARGET_LDFLAGS) -ldbus-1 -lssl -lcrypto -lpthread
          endef

          define Package/\$(PKG_NAME)/install
          	\$(INSTALL_DIR) \$(1)/usr/bin
          	\$(INSTALL_BIN) \$(PKG_BUILD_DIR)/DbusSmsForwardCPlus/DbusSmsForwardCPlus \$(1)/usr/bin/DbusSmsForwardCPlus

          	\$(INSTALL_DIR) \$(1)/etc/init.d
          	\$(INSTALL_BIN) ./files/etc/init.d/\$(PKG_NAME) \$(1)/etc/init.d/\$(PKG_NAME)

          	\$(INSTALL_DIR) \$(1)/etc/config
          	\$(INSTALL_CONF) ./files/etc/config/\$(PKG_NAME) \$(1)/etc/config/\$(PKG_NAME)
          endef

          \$(eval \$(call BuildPackage,\$(PKG_NAME)))
          EOF

          # ------- procd 启动脚本 -------
          cat > $GITHUB_WORKSPACE/openwrt-packages/${{ env.PKG_NAME }}/files/etc/init.d/${{ env.PKG_NAME }} <<'EOF'
          #!/bin/sh /etc/rc.common
          START=95
          USE_PROCD=1
          CFG=dbus-sms-forward-cplus

          start_service() {
              . /lib/functions.sh
              config_load $CFG
              config_get_bool enabled main enabled 0
              [ "$enabled" -eq 1 ] || exit 0
              config_get conf main configfile "/etc/dbus-sms-forward-cplus/config.txt"
              config_get args main args ""

              mkdir -p /etc/dbus-sms-forward-cplus
              [ -f "$conf" ] || touch "$conf"

              procd_open_instance
              procd_set_param command /usr/bin/DbusSmsForwardCPlus --configfile="$conf" $args
              procd_set_param respawn 3600 5 5
              procd_set_param stdout 1
              procd_set_param stderr 1
              procd_close_instance
          }
          EOF
          chmod +x $GITHUB_WORKSPACE/openwrt-packages/${{ env.PKG_NAME }}/files/etc/init.d/${{ env.PKG_NAME }}

          # ------- UCI 配置示例 -------
          cat > $GITHUB_WORKSPACE/openwrt-packages/${{ env.PKG_NAME }}/files/etc/config/${{ env.PKG_NAME }} <<'EOF'
          config main 'main'
              option enabled '1'
              option configfile '/etc/dbus-sms-forward-cplus/config.txt'
              option args '--sendsmsapi=enable -fB -fP'
          EOF

      - name: Build with SDK
        run: |
          set -eux
          cd "$SDK_DIR"
          # 使用 SDK 自带 feeds，并追加本地 feed
          cp feeds.conf.default feeds.conf
          echo "src-link $FEED_NAME $GITHUB_WORKSPACE/openwrt-packages" >> feeds.conf
          ./scripts/feeds update -a
          ./scripts/feeds install $PKG_NAME
          make defconfig
          make package/${{ env.PKG_NAME }}/compile V=s -j$(nproc)
          make package/index
          PKG_DIR=$(ls -d bin/packages/*/$FEED_NAME | head -n1)
          echo "PKG_DIR=$PKG_DIR" >> $GITHUB_ENV
          echo "ARCH_DIR=$(echo $PKG_DIR | sed 's#.*/bin/packages/\(.*\)/.*#\1#')" >> $GITHUB_ENV

      - name: Upload ipk artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PKG_NAME }}-qualcommax-ipq807x-24.10.1-${{ env.ARCH_DIR }}
          path: |
            ${{ env.PKG_DIR }}/${{ env.PKG_NAME }}_*.ipk
            ${{ env.PKG_DIR }}/Packages*
